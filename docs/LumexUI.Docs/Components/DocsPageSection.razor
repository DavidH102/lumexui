@namespace LumexUI.Docs.Components

@inject NavigationManager NavigationManager

<CascadingValue TValue="DocsPageSection" Value="@this" IsFixed="@true">
    <LumexElement Tag="@(Parent is null ? "h2" : "h3")"
                  Id="@_id"
                  Class="flex gap-2 text-">
        @Title

        <LumexLink Route="@Link">
            <LumexIcon Icon="@Icons.Rounded.Tag" />
        </LumexLink>
    </LumexElement>

    @ChildContent
</CascadingValue>

@code {
    [CascadingParameter] private DocsPage Page { get; set; } = default!;
    [CascadingParameter] private DocsPageSection Parent { get; set; } = default!;

    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string? Title { get; set; }

    internal int Level => (Parent?.Level ?? -1) + 1;
    private string Link => $"{_pageRelativePath}#{_id}";

    private string TitleCssClass =>
        new CssBuilder( "flex gap-2" )
            .Build();

    private string? _id;
    private string? _pageRelativePath;

    protected override void OnInitialized()
    {
        _pageRelativePath = NavigationManager.GetPageRelativePath();
        AddSelfToParent();
    }

    private void AddSelfToParent()
    {
        if( !string.IsNullOrEmpty( Title ) )
        {
            _id = BuildIdAttributeValue( Title );
            Page.AddSection( new PageSectionInfo( Title, Link, Level ) );
        }
    }

    private string BuildIdAttributeValue( string title )
    {
        var titleParts = title.Split( ' ' );
        return string.Join( "-", titleParts ).ToLowerInvariant();
    }
}
